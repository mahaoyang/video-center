<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MJ Workflow Studio | Neural Orchestration</title>

  <!-- Google Fonts: Inter & JetBrains Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap"
    rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            'studio-bg': '#08090a',
            'studio-panel': '#111214',
            'studio-border': '#1d1f23',
            'studio-accent': '#c5f341',
            'studio-text': '#e1e2e4',
          },
          fontFamily: {
            'sans': ['Inter', 'sans-serif'],
            'mono': ['JetBrains Mono', 'monospace'],
          },
        },
      },
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --accent: #c5f341;
      --bg: #08090a;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: var(--bg);
      color: #e1e2e4;
      font-feature-settings: "ss01", "ss02", "cv01";
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .shimmer-text {
      background: linear-gradient(90deg, #555, #fff, #555);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 4s infinite linear;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    .studio-panel {
      background: #111214;
      border: 1px solid #1d1f23;
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .studio-panel:hover {
      border-color: #2d2f35;
      box-shadow: 0 20px 40px -20px rgba(0, 0, 0, 0.5);
    }

    .step-section {
      opacity: 0.15;
      filter: grayscale(1);
      transition: all 0.8s ease;
      pointer-events: none;
    }

    .step-section.active {
      opacity: 1;
      filter: grayscale(0);
      pointer-events: auto;
    }

    .input-studio {
      background: transparent;
      border: none;
      outline: none;
      width: 100%;
      color: white;
      font-size: 1.125rem;
    }

    /* Custom Buttons */
    .btn-studio {
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-studio-primary {
      background: var(--accent);
      color: black;
    }

    .btn-studio-primary:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 0 30px rgba(197, 243, 65, 0.3);
    }

    .btn-studio-outline {
      border: 1px solid #2d2f35;
      color: #888;
    }

    .btn-studio-outline:hover {
      border-color: #555;
      color: white;
      background: rgba(255, 255, 255, 0.05);
    }

    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pop-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.8s ease forwards;
    }

    .animate-fade-in-up {
      animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-pop-in {
      animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .glass-panel {
      background: rgba(17, 18, 20, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* Command footer dropdown menus (avoid clipped/narrow popovers). */
    .command-footer-menu {
      width: 360px;
      max-width: min(92vw, 420px);
    }

    /* ScrollArea (lily-ui / Radix-style) */
    :where(.rt-ScrollAreaRoot) {
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      width: 100%;
      height: auto;
    }

    :where(.rt-ScrollAreaViewport) {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: auto;
      overflow: auto;
      overscroll-behavior: contain;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    :where(.rt-ScrollAreaViewport)::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    :where(.rt-ScrollAreaViewport)::-webkit-scrollbar-button {
      display: none;
      width: 0;
      height: 0;
    }

    :where(.rt-ScrollAreaViewport)>:where(.rt-ScrollAreaContent) {
      display: block !important;
      width: fit-content;
      min-width: 100%;
      flex-grow: 1;
    }

    :where(.rt-ScrollAreaScrollbar) {
      display: flex;
      position: absolute;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 999px;
      user-select: none;
      touch-action: none;
      opacity: 0;
      pointer-events: none;
      transition: opacity 120ms ease-out;
    }

    :where(.rt-ScrollAreaScrollbar)[data-state='visible'] {
      opacity: 1;
      pointer-events: auto;
    }

    :where(.rt-ScrollAreaScrollbar)[data-state='hidden'] {
      opacity: 0;
      pointer-events: none;
    }

    :where(.rt-ScrollAreaScrollbar)[data-orientation='vertical'] {
      flex-direction: column;
      width: var(--scrollarea-scrollbar-size, 6px);
      top: var(--scrollarea-scrollbar-vertical-margin-top, 8px);
      bottom: var(--scrollarea-scrollbar-vertical-margin-bottom, 8px);
      right: var(--scrollarea-scrollbar-vertical-margin-right, 8px);
    }

    :where(.rt-ScrollAreaScrollbar)[data-orientation='horizontal'] {
      flex-direction: row;
      height: var(--scrollarea-scrollbar-size, 6px);
      left: var(--scrollarea-scrollbar-horizontal-margin-left, 8px);
      right: var(--scrollarea-scrollbar-horizontal-margin-right, 8px);
      bottom: var(--scrollarea-scrollbar-horizontal-margin-bottom, 8px);
    }

    :where(.rt-ScrollAreaThumb) {
      --scrollarea-thumb-min-size: 16px;
      position: relative;
      background: rgba(197, 243, 65, 0.32);
      border-radius: inherit;
      width: 100%;
      height: 100%;
      transition: background-color 100ms;
    }

    :where(.rt-ScrollAreaThumb)::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      min-width: 16px;
      min-height: 16px;
    }

    :where(.rt-ScrollAreaThumb):hover {
      background: rgba(197, 243, 65, 0.5);
    }

    :where(.rt-ScrollAreaScrollbar)[data-orientation='vertical'] :where(.rt-ScrollAreaThumb) {
      width: 100%;
      height: auto;
    }

    :where(.rt-ScrollAreaScrollbar)[data-orientation='horizontal'] :where(.rt-ScrollAreaThumb) {
      width: auto;
      height: 100%;
    }

    :where(.rt-ScrollAreaScrollbar).rt-r-size-1 {
      --scrollarea-scrollbar-size: 6px;
    }

    :where(.rt-ScrollAreaScrollbar).rt-r-size-2 {
      --scrollarea-scrollbar-size: 8px;
    }

    @media (max-width: 640px) {
      .command-footer-menu {
        width: calc(100vw - 48px);
        max-width: calc(100vw - 48px);
      }
    }
  </style>
</head>

<body class="selection:bg-studio-accent selection:text-black">

  <!-- PURE-STREAM WORKSPACE -->
  <div class="min-h-[100dvh] h-[100dvh] flex flex-col items-center bg-studio-bg overflow-hidden relative">
    <!-- BACKGROUND LAYERS -->
    <div class="pointer-events-none absolute inset-0 overflow-hidden">
      <div class="absolute -top-56 left-1/2 -translate-x-1/2 w-[980px] h-[980px] rounded-full bg-studio-accent/10 blur-[140px]"></div>
      <div class="absolute -bottom-64 -right-64 w-[900px] h-[900px] rounded-full bg-white/5 blur-[160px]"></div>
      <div class="absolute inset-0 opacity-[0.06]" style="background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.28) 1px, transparent 0); background-size: 36px 36px;"></div>
    </div>

    <!-- STREAM DESKTOP CONTROLS -->
    <div
      class="absolute top-8 left-1/2 -translate-x-1/2 w-full max-w-5xl px-8 z-[120] pointer-events-none select-none">
      <div class="flex items-center justify-end">
        <button id="streamClearUiBtn" type="button"
          class="pointer-events-auto flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-white/70 hover:text-white hover:border-studio-accent/40 hover:bg-white/[0.07] transition-all text-[9px] font-black uppercase tracking-[0.25em]"
          title="Clear UI only (does not delete history)">
          <i class="fas fa-broom text-[10px]"></i>
          <span>Clear Chat</span>
        </button>
      </div>
    </div>

    <!-- THE INFINITE CANVAS -->
    <main id="productionStream"
      class="relative flex-1 w-full max-w-5xl overflow-y-auto px-8 pt-20 pb-64 flex flex-col gap-24 scroll-smooth scrollbar-hide">
      <!-- INITIAL WELCOME -->
      <div id="zeroState"
        class="absolute inset-0 flex flex-col items-center justify-center text-center space-y-8 animate-fade-in pointer-events-none">
        <div class="text-[60px] font-black tracking-tighter opacity-10 leading-tight select-none uppercase">
          Neural<br />Flow</div>
        <p class="text-[10px] font-black uppercase tracking-[0.6em] opacity-20">Direct Protocol Layer 9 // Ready</p>
      </div>
    </main>

    <!-- PENDING STATE (The Neural Pulse) -->
    <div id="streamPending" class="hidden fixed bottom-44 left-1/2 -translate-x-1/2 z-[110] animate-fade-in">
      <div
        class="glass-panel px-10 py-5 rounded-full border border-studio-accent/20 flex items-center gap-5 shadow-2xl bg-studio-bg/60 backdrop-blur-xl">
        <div class="relative w-5 h-5">
          <div class="absolute inset-0 border-2 border-studio-accent/20 rounded-full"></div>
          <div class="absolute inset-0 border-2 border-studio-accent border-t-transparent rounded-full animate-spin">
          </div>
        </div>
        <div class="flex flex-col">
          <span id="progressText" class="text-sm font-black text-studio-accent leading-none">0%</span>
          <span class="text-[8px] font-black uppercase tracking-widest opacity-40 mt-1">Collecting Latent Samples</span>
        </div>
      </div>
    </div>

    <!-- STREAM SCROLL SHORTCUTS -->
    <div id="streamScrollShortcuts" class="fixed right-6 bottom-40 md:bottom-44 z-[115] flex flex-col gap-2">
      <button id="streamScrollTopBtn" type="button"
        class="hidden w-10 h-10 rounded-2xl bg-black/60 border border-white/10 text-white/70 hover:text-white hover:border-studio-accent/40 transition-all shadow-2xl"
        title="滚动到顶部" aria-label="滚动到顶部">
        <i class="fas fa-arrow-up text-[10px]"></i>
      </button>
      <button id="streamScrollBottomBtn" type="button"
        class="hidden w-10 h-10 rounded-2xl bg-black/60 border border-white/10 text-white/70 hover:text-white hover:border-studio-accent/40 transition-all shadow-2xl"
        title="滚动到底部" aria-label="滚动到底部">
        <i class="fas fa-arrow-down text-[10px]"></i>
      </button>
    </div>

    <!-- FLOATING COMMAND CENTER (Premium Studio Input) -->
    <div id="commandHub"
      class="fixed bottom-12 left-1/2 -translate-x-1/2 w-full max-w-5xl px-8 z-[100] transition-all duration-700">

      <!-- REFERENCE TRAY -->
      <div id="referenceTray"
        class="group mb-4 flex items-center overflow-x-auto overflow-y-visible pb-4 pt-4 scrollbar-hide px-2">
        <!-- Thumbnails injected here -->
      </div>

      <div
        class="glass-panel p-2.5 rounded-[2.5rem] border border-white/5 shadow-3xl bg-studio-panel/80 backdrop-blur-3xl">
        <div class="flex items-end gap-3 p-1">
          <div id="uploadTrigger"
            class="relative w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-white/5 hover:bg-studio-accent hover:text-studio-bg cursor-pointer transition-all duration-300 group">
            <i class="fas fa-paperclip text-xs group-hover:rotate-12 transition-transform"></i>
            <input type="file" id="imageUpload"
              class="absolute inset-0 z-10 opacity-0 cursor-pointer"
              multiple accept="image/*,video/*,audio/*,.srt,text/plain" />
            <button type="button" id="padMatrixBtn"
              class="absolute -bottom-1 -right-1 z-20 px-2 py-1 rounded-full bg-black/60 border border-white/10 text-[7px] font-black uppercase tracking-widest text-white/70 hover:text-studio-accent hover:border-studio-accent/30 transition-all">
              素材 <span id="padCount" class="ml-1 text-studio-accent">0</span>
            </button>
            <button type="button" id="padZipDownloadBtn"
              class="absolute -top-1 -right-1 z-20 px-2 py-1 rounded-full bg-black/60 border border-white/10 text-[7px] font-black uppercase tracking-widest text-white/70 hover:text-studio-accent hover:border-studio-accent/30 transition-all"
              title="打包下载素材（ZIP）" aria-label="打包下载素材（ZIP）">
              ZIP
            </button>
          </div>
          <div class="relative flex-1">
            <textarea id="promptInput"
              class="w-full bg-transparent border-none focus:ring-0 p-4 text-sm placeholder:opacity-20 resize-none min-h-[56px] max-h-48 leading-relaxed font-medium"
              placeholder="Command the Neural Engine..."></textarea>
            <div id="promptBeautifySpinner" class="hidden absolute right-4 top-4 w-5 h-5 pointer-events-none">
              <div class="absolute inset-0 border-2 border-studio-accent/25 rounded-full"></div>
              <div class="absolute inset-0 border-2 border-studio-accent border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div id="youtubeExtraWrap" class="hidden px-4 pb-4 -mt-1">
              <textarea id="youtubeExtraInput"
                class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-[12px] font-medium focus:outline-none focus:border-studio-accent/50 focus:ring-2 focus:ring-studio-accent/25 focus:ring-inset transition-all resize-none min-h-[44px] max-h-32 leading-relaxed"
                placeholder="剩余补充的要求（可选）：风格、受众、禁忌、口吻、是否要加 CTA、是否要分段…（默认英文输出；如需中文请写：输出中文/简体中文）"></textarea>
            </div>
          </div>
          <div class="relative">
            <button id="commandModeBtn" type="button"
              class="w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-white/5 border border-white/10 text-white/70 hover:text-studio-accent hover:border-studio-accent/40 hover:bg-white/10 transition-all">
              <i class="fas fa-layer-group text-xs"></i>
              <span id="commandModeBadge"
                class="absolute -bottom-1 -right-1 px-2 py-1 rounded-full bg-black/70 border border-white/10 text-[7px] font-black uppercase tracking-widest text-white/70">
                MJ
              </span>
            </button>
            <div id="commandModeMenu"
              class="hidden absolute right-0 bottom-full mb-3 w-[320px] rounded-[1.8rem] bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden">
              <div class="p-4 border-b border-white/10">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-[9px] font-black uppercase tracking-[0.25em] opacity-50">功能</div>
                  <div class="text-[9px] font-mono opacity-30">Search</div>
                </div>
                <input id="commandModeSearch" type="text"
                  class="mt-3 w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-[12px] font-medium focus:outline-none focus:border-studio-accent/50 focus:ring-2 focus:ring-studio-accent/25 focus:ring-inset transition-all"
                  placeholder="搜索：mj / 视频 / 美化 / describe…" />
              </div>

              <div class="max-h-[420px] overflow-auto scrollbar-hide">
                <div data-command-mode-group="create">
                  <div class="px-4 pt-4 pb-2 text-[9px] font-black uppercase tracking-[0.25em] opacity-40">生成</div>
                  <button type="button" data-command-mode="mj" data-command-mode-keywords="mj midjourney image grid 生图"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">MJ 生图</span>
                    <span class="text-[10px] font-mono opacity-40">Image</span>
                  </button>
                  <button type="button" data-command-mode="suno" data-command-mode-keywords="suno 歌曲 音乐 提示词 metatag 元标签 歌词 风格"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">Suno 提示词</span>
                    <span class="text-[10px] font-mono opacity-40">Music</span>
                  </button>
                  <button type="button" data-command-mode="video" data-command-mode-keywords="video 生视频"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">生视频</span>
                    <span class="text-[10px] font-mono opacity-40">Video</span>
                  </button>
                </div>

                <div data-command-mode-group="edit">
                  <div class="px-4 pt-4 pb-2 text-[9px] font-black uppercase tracking-[0.25em] opacity-40">编辑</div>
                  <button type="button" data-command-mode="pedit" data-command-mode-keywords="gemini image edit pro 生成 编辑"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">Gemini 生图/编辑（Pro Image）</span>
                    <span class="text-[10px] font-mono opacity-40">Image</span>
                  </button>
                </div>

                <div data-command-mode-group="tools">
                  <div class="px-4 pt-4 pb-2 text-[9px] font-black uppercase tracking-[0.25em] opacity-40">工具</div>
                  <button type="button" data-command-mode="deconstruct" data-command-mode-keywords="describe 反推 提示词 gemini"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">反推提示词（Gemini）</span>
                    <span class="text-[10px] font-mono opacity-40">Describe</span>
                  </button>
                  <button type="button" data-command-mode="beautify" data-command-mode-keywords="polish 美化 提示词 gemini"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">提示词美化（Gemini）</span>
                    <span class="text-[10px] font-mono opacity-40">Polish</span>
                  </button>
                  <button type="button" data-command-mode="youtube" data-command-mode-keywords="youtube 标题 简介 文案 人味 gemini flash3"
                    class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all flex items-center justify-between">
                    <span class="font-medium">YouTube 标题/简介（Gemini Flash3）</span>
                    <span class="text-[10px] font-mono opacity-40">YT</span>
                  </button>
                </div>

                <div id="commandModeEmpty" class="hidden px-4 py-10 text-center">
                  <div class="text-[10px] font-black uppercase tracking-[0.25em] opacity-40">No Match</div>
                  <div class="mt-2 text-[10px] font-mono opacity-35">换个关键词试试</div>
                </div>
              </div>

              <div class="px-4 py-3 text-[9px] font-mono opacity-35 border-t border-white/10">
                提示：小飞机会执行当前模式
              </div>
            </div>
          </div>
          <div class="relative group">
            <button id="step3Next" type="button"
              class="w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-studio-accent text-studio-bg hover:scale-105 active:scale-95 transition-all shadow-[0_0_25px_rgba(197,243,65,0.25)]">
              <i class="fas fa-paper-plane text-xs"></i>
            </button>
            <div
              class="pointer-events-none absolute right-0 -top-2 -translate-y-full opacity-0 group-hover:opacity-100 transition-opacity">
              <div class="px-3 py-2 rounded-2xl bg-black/70 border border-white/10 text-[9px] font-black uppercase tracking-[0.25em] text-white/70 whitespace-nowrap">Execute</div>
            </div>
          </div>
        </div>

        <div class="px-6 py-3 border-t border-white/[0.03] mt-1 text-white">
          <div id="commandFooterChips"
            class="flex items-center justify-end gap-2 overflow-x-auto scrollbar-hide"></div>

          <div class="flex items-center gap-8 mt-3">
            <div id="matrixOpenTrigger"
              class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all group">
              <i class="fas fa-sliders-h text-[10px] group-hover:text-studio-accent"></i>
              <span class="text-[8px] font-black uppercase tracking-[0.2em]">参数设置</span>
            </div>

            <div id="plannerOpenTrigger"
              class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all group">
              <i class="fas fa-comments text-[10px] group-hover:text-studio-accent"></i>
              <span class="text-[8px] font-black uppercase tracking-[0.2em]">Planner</span>
            </div>

            <div id="vaultOpenTrigger"
              class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all ml-auto group">
              <i class="fas fa-folder-open text-[10px] group-hover:text-studio-accent"></i>
              <span class="text-[8px] font-black uppercase tracking-[0.2em]">历史记录</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- THE PRODUCTION VAULT (Slide-over Overlay) -->
  <div id="historyOverlay" class="fixed inset-0 z-[200] pointer-events-none group">
    <div id="historyBackdrop"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="historyPanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-12 overflow-y-auto">
      <div class="flex items-center justify-between mb-16">
        <div class="flex items-center gap-4">
          <div class="w-2 h-2 bg-studio-accent rounded-full shadow-[0_0_10px_var(--studio-accent)]"></div>
          <span class="text-[12px] font-black uppercase tracking-[0.4em]">历史记录</span>
          <span class="px-2 py-1 rounded-lg bg-white/5 text-[8px] font-mono opacity-40">COUNT <span
              id="conversationCount">0</span></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="saveConversationBtn" type="button"
            class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white">
            Save Chat
          </button>
          <button id="clearConversationBtn" type="button"
            class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white hover:border-red-500/30 hover:text-red-400">
            Clear Chat
          </button>
          <button id="vaultCloseBtn" type="button"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
            <i class="fas fa-times text-xs opacity-30"></i>
          </button>
        </div>
      </div>
      <div id="historyList" class="flex flex-col gap-4"></div>
      <div
        class="mt-40 pt-10 border-t border-white/5 opacity-20 text-[8px] font-black uppercase tracking-[0.3em] text-center">
        End of Neural Record</div>
    </div>
  </div>

  <!-- THE MATRIX OVERLAY (Parameters) -->
  <div id="matrixOverlay" class="fixed inset-0 z-[200] pointer-events-none group">
    <div id="matrixBackdrop"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="matrixPanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-12 overflow-y-auto">
      <div class="flex items-center justify-between mb-16">
        <div class="flex items-center gap-4">
          <i class="fas fa-sliders-h text-studio-accent text-xs"></i>
          <span class="text-[12px] font-black uppercase tracking-[0.4em]">参数设置</span>
        </div>
        <button id="matrixCloseBtn" type="button"
          class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
          <i class="fas fa-times text-xs opacity-30"></i>
        </button>
      </div>

      <div class="space-y-12">
        <div class="space-y-4">
          <div class="flex items-center justify-between gap-4">
            <label class="text-[9px] font-black uppercase tracking-widest opacity-30">MJ Prompt 参数</label>
          </div>
	          <div class="flex items-center gap-3">
	            <span id="mjArCurrent"
	              class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-[9px] font-mono opacity-50 mr-2 tracking-widest">--ar 1:1</span>
	            <div class="relative">
	              <button id="mjArBtn" type="button"
	                class="px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between gap-3 min-w-[140px]">
	                <span id="mjArLabel" class="font-medium">1:1</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjArMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <button id="mjClearArBtn" type="button"
	              class="px-3 py-2 rounded-2xl bg-white/5 border border-white/10 text-white/60 hover:border-red-500/30 hover:text-red-200 transition-all"
	              title="重置 AR">
	              <i class="fas fa-times text-[10px]"></i>
	            </button>
	          </div>
	          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
	            <div class="relative">
	              <button id="mjStyleBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjStyleLabel" class="font-medium">Style 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjStyleMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjStylizeBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjStylizeLabel" class="font-medium">Stylize 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjStylizeMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjChaosBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjChaosLabel" class="font-medium">Chaos 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjChaosMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjQualityBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjQualityLabel" class="font-medium">Quality 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjQualityMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjWeirdBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjWeirdLabel" class="font-medium">Weird 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjWeirdMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjStopBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjStopLabel" class="font-medium">Stop 默认</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjStopMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <div class="relative">
	              <button id="mjSeedBtn" type="button"
	                class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
	                <span id="mjSeedLabel" class="font-medium">Seed 随机</span>
	                <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
	              </button>
		              <div id="mjSeedMenu"
		                class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
		                <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
		                <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
		                  <div class="rt-ScrollAreaThumb"></div>
		                </div>
		              </div>
	            </div>
	            <button id="mjTileBtn" type="button"
	              class="w-full px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-[12px] font-black uppercase tracking-[0.18em] text-white/70 hover:border-studio-accent/40 hover:text-white transition-all">
	              Tile
	            </button>
	          </div>
	          <div id="mjDetectedParams" class="flex flex-wrap gap-3 min-h-[40px]">
	            <!-- Chips injected here -->
	          </div>
	        </div>

        <div class="space-y-4 pt-10 border-t border-white/5">
          <div class="flex items-center justify-between gap-4">
            <label class="text-[9px] font-black uppercase tracking-widest opacity-30">MJ 包装器</label>
          </div>
          <div id="mjPromptPreview"
            class="w-full min-h-[140px] max-h-[40vh] overflow-auto bg-white/[0.02] border border-white/10 rounded-2xl p-5 text-[11px] font-mono leading-relaxed whitespace-pre-wrap break-words select-none"></div>
          <div id="mjWrapperStats" class="text-[9px] font-mono opacity-40 leading-relaxed"></div>
          <div class="text-[9px] opacity-30 leading-relaxed">
            说明：参考图与 SREF/CREF 在“生成”时会按需补全公网 URL（惰性上传到 CDN）；平时预览优先走本地 <code>/uploads</code>。
          </div>
        </div>

        <div class="space-y-4 pt-10 border-t border-white/5">
          <div class="flex items-center justify-between gap-4">
            <label class="text-[9px] font-black uppercase tracking-widest opacity-30">参考图选择（勾选素材 / SREF / CREF）</label>
            <button id="clearRefsBtn" type="button"
              class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white">
              清空勾选
            </button>
          </div>
          <div id="referenceList" class="grid grid-cols-4 gap-3"></div>
        </div>

        <div class="space-y-4 pt-10 border-t border-white/5">
          <label class="text-[9px] font-black uppercase tracking-widest opacity-30">Gemini Pro Image 参数</label>
          <div id="pEditPanel" class="animate-fade-in">
            <div class="rounded-[2rem] border border-white/10 bg-white/[0.02] p-5">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div
                    class="w-9 h-9 rounded-2xl bg-studio-accent/10 border border-studio-accent/20 flex items-center justify-center">
                    <i class="fas fa-wand-magic-sparkles text-[10px] text-studio-accent"></i>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase tracking-[0.3em] opacity-60">Gemini Pro Image</span>
                    <span class="text-[9px] font-mono opacity-40">参数用于生图/编辑（默认 2K / 16:9）</span>
                  </div>
                </div>
              </div>

              <div class="mt-5 grid grid-cols-2 gap-4">
                <div>
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Aspect</div>
                  <div class="relative">
                    <button id="pEditAspectBtn" type="button"
                      class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                      <span id="pEditAspectLabel" class="font-medium">16:9</span>
                      <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                    </button>
	                  <div id="pEditAspectMenu"
	                      class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
	                      <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent">
	                        <button type="button" data-gimage-aspect="1:1"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">1:1</button>
	                        <button type="button" data-gimage-aspect="2:3"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">2:3</button>
	                        <button type="button" data-gimage-aspect="3:2"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">3:2</button>
	                        <button type="button" data-gimage-aspect="3:4"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">3:4</button>
	                        <button type="button" data-gimage-aspect="4:3"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">4:3</button>
	                        <button type="button" data-gimage-aspect="16:9"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">16:9</button>
	                        <button type="button" data-gimage-aspect="9:16"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">9:16</button>
	                        <button type="button" data-gimage-aspect="21:9"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">21:9</button>
	                      </div></div>
	                      <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
	                        <div class="rt-ScrollAreaThumb"></div>
	                      </div>
	                    </div>
                  </div>
                </div>
                <div>
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Size</div>
                  <div class="relative">
                    <button id="pEditSizeBtn" type="button"
                      class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                      <span id="pEditSizeLabel" class="font-medium">2K</span>
                      <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                    </button>
	                  <div id="pEditSizeMenu"
	                      class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
	                      <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent">
	                        <button type="button" data-gimage-size="1K"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">1K</button>
	                        <button type="button" data-gimage-size="2K"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">2K</button>
	                        <button type="button" data-gimage-size="4K"
	                          class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">4K</button>
	                      </div></div>
	                      <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
	                        <div class="rt-ScrollAreaThumb"></div>
	                      </div>
	                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-5 flex items-center justify-between gap-4">
                <div class="text-[9px] font-black uppercase tracking-[0.25em] opacity-50">参考图（可选）</div>
                <button id="pEditClearSelected" type="button"
                  class="px-4 py-2 rounded-2xl bg-white/5 border border-white/10 text-[9px] font-black uppercase tracking-widest text-white/70 hover:border-white/20 hover:text-white transition-all">
                  Clear
                </button>
              </div>
              <div id="pEditSelectedRefs" class="mt-3 flex items-center gap-2 overflow-x-auto pb-1"></div>
              <div class="mt-4 text-[10px] font-mono opacity-40 leading-relaxed">
                在图片栏点击图片加入/移除参考图；不选参考图则文生图。
              </div>
            </div>
          </div>
        </div>

        <div id="commandExtraPanel" class="space-y-6 pt-10 border-t border-white/5">
          <label class="text-[9px] font-black uppercase tracking-widest opacity-30">其他参数</label>

          <div id="commandBeautifyPanel">
            <div class="rounded-[2rem] border border-white/10 bg-white/[0.02] p-5">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div
                    class="w-9 h-9 rounded-2xl bg-studio-accent/10 border border-studio-accent/20 flex items-center justify-center">
                    <i class="fas fa-pen-nib text-[10px] text-studio-accent"></i>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase tracking-[0.3em] opacity-60">提示词美化</span>
                    <span class="text-[9px] font-mono opacity-40">仅美化提示词主体，不改参数</span>
                  </div>
                </div>
              </div>
	              <div class="mt-4">
	                <input id="commandBeautifyHint" type="text"
	                  class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-[12px] font-medium focus:outline-none focus:border-studio-accent/50 focus:ring-2 focus:ring-studio-accent/25 focus:ring-inset transition-all"
	                  placeholder="美化建议 / 方向（可选）" />
	              </div>
            </div>
          </div>

          <div id="commandVideoPanel">
            <div class="rounded-[2rem] border border-white/10 bg-white/[0.02] p-5">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                  <div
                    class="w-9 h-9 rounded-2xl bg-studio-accent/10 border border-studio-accent/20 flex items-center justify-center">
                    <i class="fas fa-film text-[10px] text-studio-accent"></i>
                  </div>
                  <div class="flex flex-col">
                    <span class="text-[9px] font-black uppercase tracking-[0.3em] opacity-60">Video Generate</span>
                    <span class="text-[9px] font-mono opacity-40">注意：生视频成本很高，请确认参数</span>
                  </div>
                </div>
              </div>

              <div class="mt-5 grid grid-cols-2 gap-4">
                <div class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Provider</div>
                  <button id="videoProviderBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoProviderLabel" class="font-medium">Gemini</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoProviderMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent">
                      <button type="button" data-video-provider="gemini"
                        class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">Gemini</button>
                      <button type="button" data-video-provider="sora"
                        class="w-full px-4 py-3 text-left text-[12px] hover:bg-white/5 transition-all">Sora</button>
                    </div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>

                <div class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Model</div>
                  <button id="videoModelBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoModelLabel" class="font-medium">默认</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoModelMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-4 gap-4">
                <div id="videoSecondsWrap" class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Seconds</div>
                  <button id="videoSecondsBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoSecondsLabel" class="font-medium">默认</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoSecondsMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
                <div id="videoModeWrap">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Mode</div>
                  <div class="relative">
                    <button id="videoModeBtn" type="button"
                      class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                      <span id="videoModeLabel" class="font-medium">STD</span>
                      <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                    </button>
                    <div id="videoModeMenu"
                      class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                      <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                      <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                        <div class="rt-ScrollAreaThumb"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="videoAspectWrap" class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Aspect</div>
                  <button id="videoAspectBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoAspectLabel" class="font-medium">默认</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoAspectMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
                <div id="videoSizeWrap" class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Size</div>
                  <button id="videoSizeBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoSizeLabel" class="font-medium">默认</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoSizeMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-2 gap-4">
                <div class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">Start Frame (optional)</div>
                  <button id="videoStartRefBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoStartRefLabel" class="font-medium">（无）</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoStartRefMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
                <div class="relative">
                  <div class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-2">End Frame (optional)</div>
                  <button id="videoEndRefBtn" type="button"
                    class="w-full px-4 py-3 rounded-2xl bg-white/5 border border-white/10 text-left text-[12px] hover:border-studio-accent/40 transition-all flex items-center justify-between">
                    <span id="videoEndRefLabel" class="font-medium">（无）</span>
                    <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                  </button>
                  <div id="videoEndRefMenu"
                    class="hidden absolute left-0 right-0 top-full mt-2 max-h-72 rounded-2xl bg-black/85 border border-white/10 backdrop-blur-xl shadow-2xl overflow-hidden rt-ScrollAreaRoot z-[350] pointer-events-auto">
                    <div class="rt-ScrollAreaViewport max-h-72 overflow-auto"><div class="rt-ScrollAreaContent"></div></div>
                    <div class="rt-ScrollAreaScrollbar rt-r-size-1" data-orientation="vertical">
                      <div class="rt-ScrollAreaThumb"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- THE PLANNER OVERLAY (Pure Chat Mode) -->
  <div id="plannerOverlay" class="fixed inset-0 z-[200] pointer-events-none group">
    <div id="plannerBackdrop"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="plannerPanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-10 overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <i class="fas fa-comments text-studio-accent text-xs"></i>
          <span class="text-[12px] font-black uppercase tracking-[0.4em]">Planner Chat</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="plannerClear" type="button"
            class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white hover:border-red-500/30 hover:text-red-300">
            Clear
          </button>
          <button id="plannerCloseBtn" type="button"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
            <i class="fas fa-times text-xs opacity-30"></i>
          </button>
        </div>
      </div>

      <div id="plannerMessages" class="flex-1 overflow-y-auto pr-2 flex flex-col gap-4 scrollbar-hide"></div>

      <div class="mt-6 glass-panel p-2.5 rounded-[2.2rem] border border-white/5 bg-studio-panel/70">
        <div class="flex items-end gap-3 p-1">
          <textarea id="plannerInput"
            class="flex-1 bg-transparent border-none focus:ring-0 p-4 text-sm placeholder:opacity-20 resize-none min-h-[72px] max-h-[260px] leading-relaxed font-medium"
            placeholder="输入需求：Ctrl+Enter 走 Planner 对话；Ctrl+Shift+Enter 直接生成 MV 分镜..."></textarea>
          <div class="flex flex-col gap-2">
            <button id="plannerSendMv" type="button" title="MV 分镜（Ctrl+Shift+Enter）"
              class="h-10 px-4 flex items-center justify-center rounded-2xl bg-white/10 border border-white/15 text-white/90 hover:border-studio-accent/50 hover:text-studio-accent transition-all text-[10px] font-black tracking-[0.15em]">
              MV
            </button>
            <button id="plannerSend" type="button" title="Planner 对话（Ctrl+Enter）"
              class="w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-studio-accent text-studio-bg hover:scale-105 active:scale-95 transition-all shadow-[0_0_25px_rgba(197,243,65,0.25)]">
              <i class="fas fa-paper-plane text-xs"></i>
            </button>
          </div>
        </div>
        <div class="px-5 pb-3 text-[9px] font-mono opacity-30">
          说明：`MV` 按钮会用 Gemini 3 Flash 按预置规则输出 MV 分镜；常规发送仍可规划 MJ + Suno（LYRICS_PROMPT / STYLE_PROMPT）。
        </div>
      </div>
    </div>
  </div>

  <!-- THE TRACE OVERLAY (Lineage / 链路追踪) -->
  <div id="traceOverlay" class="fixed inset-0 z-[210] pointer-events-none group">
    <div id="traceBackdrop"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="tracePanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-3xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-10 overflow-hidden flex flex-col">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4 min-w-0">
          <i class="fas fa-sitemap text-studio-accent text-xs"></i>
          <div class="min-w-0">
            <div class="text-[12px] font-black uppercase tracking-[0.4em]">链路追踪</div>
            <div id="traceSubtitle" class="mt-1 text-[9px] font-mono opacity-35 truncate">选择一条记录查看素材路径与可重做步骤</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="traceCloseBtn" type="button"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
            <i class="fas fa-times text-xs opacity-30"></i>
          </button>
        </div>
      </div>

      <div id="traceContent" class="flex-1 overflow-y-auto pr-2 scrollbar-hide"></div>

      <div class="mt-6 pt-4 border-t border-white/5 text-[9px] font-mono opacity-30">
        提示：在链路中点 “重做” 可从中间步骤重新生成（不会自动删除后续素材）。
      </div>
    </div>
  </div>

  <!-- TINY HUD FOOTER -->
  <div
    class="fixed bottom-4 left-6 pointer-events-none opacity-20 text-[8px] font-black uppercase tracking-[0.4em] z-[50]">
    Studio Layer 9 // Enterprise Protocol
  </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script type="module" src="/assets/app.js"></script>
</body>

</html>
