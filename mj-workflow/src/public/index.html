<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MJ Workflow Studio | Neural Orchestration</title>

  <!-- Google Fonts: Inter & JetBrains Mono -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap"
    rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          colors: {
            'studio-bg': '#08090a',
            'studio-panel': '#111214',
            'studio-border': '#1d1f23',
            'studio-accent': '#c5f341',
            'studio-text': '#e1e2e4',
          },
          fontFamily: {
            'sans': ['Inter', 'sans-serif'],
            'mono': ['JetBrains Mono', 'monospace'],
          },
        },
      },
    };
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --accent: #c5f341;
      --bg: #08090a;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: var(--bg);
      color: #e1e2e4;
      font-feature-settings: "ss01", "ss02", "cv01";
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    .shimmer-text {
      background: linear-gradient(90deg, #555, #fff, #555);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 4s infinite linear;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    .studio-panel {
      background: #111214;
      border: 1px solid #1d1f23;
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .studio-panel:hover {
      border-color: #2d2f35;
      box-shadow: 0 20px 40px -20px rgba(0, 0, 0, 0.5);
    }

    .step-section {
      opacity: 0.15;
      filter: grayscale(1);
      transition: all 0.8s ease;
      pointer-events: none;
    }

    .step-section.active {
      opacity: 1;
      filter: grayscale(0);
      pointer-events: auto;
    }

    .input-studio {
      background: transparent;
      border: none;
      outline: none;
      width: 100%;
      color: white;
      font-size: 1.125rem;
    }

    /* Custom Buttons */
    .btn-studio {
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-studio-primary {
      background: var(--accent);
      color: black;
    }

    .btn-studio-primary:hover:not(:disabled) {
      transform: scale(1.02);
      box-shadow: 0 0 30px rgba(197, 243, 65, 0.3);
    }

    .btn-studio-outline {
      border: 1px solid #2d2f35;
      color: #888;
    }

    .btn-studio-outline:hover {
      border-color: #555;
      color: white;
      background: rgba(255, 255, 255, 0.05);
    }

    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fade-in-up {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pop-in {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.8s ease forwards;
    }

    .animate-fade-in-up {
      animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .animate-pop-in {
      animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .glass-panel {
      background: rgba(17, 18, 20, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
  </style>
</head>

<body class="selection:bg-studio-accent selection:text-black">

  <!-- PURE-STREAM WORKSPACE -->
  <div class="min-h-[100dvh] h-[100dvh] flex flex-col items-center bg-studio-bg overflow-hidden relative">
    <!-- BACKGROUND LAYERS -->
    <div class="pointer-events-none absolute inset-0 overflow-hidden">
      <div class="absolute -top-56 left-1/2 -translate-x-1/2 w-[980px] h-[980px] rounded-full bg-studio-accent/10 blur-[140px]"></div>
      <div class="absolute -bottom-64 -right-64 w-[900px] h-[900px] rounded-full bg-white/5 blur-[160px]"></div>
      <div class="absolute inset-0 opacity-[0.06]" style="background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.28) 1px, transparent 0); background-size: 36px 36px;"></div>
    </div>

    <!-- THE INFINITE CANVAS -->
    <main id="productionStream"
      class="relative flex-1 w-full max-w-5xl overflow-y-auto px-8 pt-20 pb-64 flex flex-col gap-24 scroll-smooth scrollbar-hide">
      <!-- INITIAL WELCOME -->
      <div id="zeroState"
        class="absolute inset-0 flex flex-col items-center justify-center text-center space-y-8 animate-fade-in pointer-events-none">
        <div class="text-[60px] font-black tracking-tighter opacity-10 leading-tight select-none uppercase">
          Neural<br />Flow</div>
        <p class="text-[10px] font-black uppercase tracking-[0.6em] opacity-20">Direct Protocol Layer 9 // Ready</p>
      </div>
    </main>

    <!-- PENDING STATE (The Neural Pulse) -->
    <div id="streamPending" class="hidden fixed bottom-44 left-1/2 -translate-x-1/2 z-[110] animate-fade-in">
      <div
        class="glass-panel px-10 py-5 rounded-full border border-studio-accent/20 flex items-center gap-5 shadow-2xl bg-studio-bg/60 backdrop-blur-xl">
        <div class="relative w-5 h-5">
          <div class="absolute inset-0 border-2 border-studio-accent/20 rounded-full"></div>
          <div class="absolute inset-0 border-2 border-studio-accent border-t-transparent rounded-full animate-spin">
          </div>
        </div>
        <div class="flex flex-col">
          <span id="progressText" class="text-sm font-black text-studio-accent leading-none">0%</span>
          <span class="text-[8px] font-black uppercase tracking-widest opacity-40 mt-1">Collecting Latent Samples</span>
        </div>
      </div>
    </div>

    <!-- FLOATING COMMAND CENTER (Premium Studio Input) -->
    <div id="commandHub"
      class="fixed bottom-12 left-1/2 -translate-x-1/2 w-full max-w-5xl px-8 z-[100] transition-all duration-700">

      <!-- REFERENCE TRAY -->
      <div id="referenceTray"
        class="group mb-4 flex items-center overflow-x-auto overflow-y-visible pb-4 pt-4 scrollbar-hide px-2">
        <!-- Thumbnails injected here -->
      </div>

      <div
        class="glass-panel p-2.5 rounded-[2.5rem] border border-white/5 shadow-3xl bg-studio-panel/80 backdrop-blur-3xl">
        <div class="flex items-end gap-3 p-1">
          <div onclick="document.getElementById('imageUpload')?.click()"
            class="relative w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-white/5 hover:bg-studio-accent hover:text-studio-bg cursor-pointer transition-all duration-300 group">
            <i class="fas fa-paperclip text-xs group-hover:rotate-12 transition-transform"></i>
            <input type="file" id="imageUpload" class="hidden" multiple accept="image/*" />
            <button type="button" onclick="event.stopPropagation(); toggleMatrix(true)"
              class="absolute -bottom-1 -right-1 px-2 py-1 rounded-full bg-black/60 border border-white/10 text-[7px] font-black uppercase tracking-widest text-white/70 hover:text-studio-accent hover:border-studio-accent/30 transition-all">
              Pad <span id="padCount" class="ml-1 text-studio-accent">0</span>
            </button>
          </div>
          <textarea id="promptInput"
            class="flex-1 bg-transparent border-none focus:ring-0 p-4 text-sm placeholder:opacity-20 resize-none min-h-[56px] max-h-48 leading-relaxed font-medium"
            placeholder="Command the Neural Engine..."></textarea>
          <button id="step3Next" onclick="generateImage()"
            class="w-14 h-14 flex items-center justify-center rounded-[1.8rem] bg-studio-accent text-studio-bg hover:scale-105 active:scale-95 transition-all shadow-[0_0_25px_rgba(197,243,65,0.25)]">
            <i class="fas fa-paper-plane text-xs"></i>
          </button>
        </div>

        <div class="flex items-center gap-8 px-6 py-2.5 border-t border-white/[0.03] mt-1 text-white">
          <!-- Aspect Ratio Console -->
          <div class="flex items-center gap-3">
            <span id="mjArCurrent" class="text-[9px] font-mono opacity-20 mr-2 tracking-widest">--ar 1:1</span>
            <div class="flex bg-white/5 rounded-lg overflow-hidden border border-white/5">
              <button data-ar="1:1"
                class="mj-ar-btn px-3 py-1.5 hover:bg-studio-accent hover:text-studio-bg transition-all text-[8px] font-black border-r border-white/5">1:1</button>
              <button data-ar="16:9"
                class="mj-ar-btn px-3 py-1.5 hover:bg-studio-accent hover:text-studio-bg transition-all text-[8px] font-black border-r border-white/5">16:9</button>
              <button data-ar="9:16"
                class="mj-ar-btn px-3 py-1.5 hover:bg-studio-accent hover:text-studio-bg transition-all text-[8px] font-black border-r border-white/5">9:16</button>
              <button data-ar="2:3"
                class="mj-ar-btn px-3 py-1.5 hover:bg-studio-accent hover:text-studio-bg transition-all text-[8px] font-black border-r border-white/5">2:3</button>
              <button id="mjClearArBtn"
                class="px-2 py-1.5 hover:bg-red-500 hover:text-white transition-all text-[8px] font-black"><i
                  class="fas fa-times"></i></button>
            </div>
          </div>

          <div class="w-px h-4 bg-white/5 hidden md:block"></div>

          <!-- Analysis Console -->
          <div class="flex items-center gap-8">
            <div class="flex items-center gap-2 group cursor-pointer relative">
              <i
                class="fas fa-brain text-[10px] opacity-30 group-hover:text-studio-accent group-hover:opacity-100 transition-all"></i>
              <select id="describeEngineSelect"
                class="bg-transparent border-none text-[8px] font-black uppercase tracking-[0.2em] text-white/30 group-hover:text-white outline-none cursor-pointer appearance-none transition-all">
                <option value="gemini" class="bg-studio-panel text-white">Gemini Pro</option>
                <option value="mj" class="bg-studio-panel text-white">MJ Describe</option>
                <option value="vision:gpt-4o" class="bg-studio-panel text-white">GPT-4o Vision</option>
              </select>
            </div>

            <div id="deconstructTrigger" onclick="window.deconstructAssets()"
              class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all group text-white">
              <i class="fas fa-fingerprint text-[10px] group-hover:text-studio-accent"></i>
              <span class="text-[8px] font-black uppercase tracking-[0.2em]">Deconstruct</span>
            </div>
          </div>

          <div onclick="toggleMatrix(true)"
            class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all group">
            <i class="fas fa-sliders-h text-[10px] group-hover:text-studio-accent"></i>
            <span class="text-[8px] font-black uppercase tracking-[0.2em]">Matrix</span>
          </div>

          <div onclick="scrollToHistory()"
            class="flex items-center gap-2 opacity-30 hover:opacity-100 cursor-pointer transition-all ml-auto group">
            <i class="fas fa-folder-open text-[10px] group-hover:text-studio-accent"></i>
            <span class="text-[8px] font-black uppercase tracking-[0.2em]">Vault</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- THE PRODUCTION VAULT (Slide-over Overlay) -->
  <div id="historyOverlay" class="fixed inset-0 z-[200] pointer-events-none group">
    <div id="historyBackdrop" onclick="toggleVault(false)"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="historyPanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-12 overflow-y-auto">
      <div class="flex items-center justify-between mb-16">
        <div class="flex items-center gap-4">
          <div class="w-2 h-2 bg-studio-accent rounded-full shadow-[0_0_10px_var(--studio-accent)]"></div>
          <span class="text-[12px] font-black uppercase tracking-[0.4em]">Integrated Archive</span>
          <span class="px-2 py-1 rounded-lg bg-white/5 text-[8px] font-mono opacity-40">CHAT <span
              id="conversationCount">0</span></span>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="window.saveConversation?.()"
            class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white">
            Save Chat
          </button>
          <button onclick="window.clearConversation?.()"
            class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white hover:border-red-500/30 hover:text-red-400">
            Clear Chat
          </button>
          <button onclick="toggleVault(false)"
            class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
            <i class="fas fa-times text-xs opacity-30"></i>
          </button>
        </div>
      </div>
      <div id="historyList" class="grid grid-cols-2 gap-6"></div>
      <div
        class="mt-40 pt-10 border-t border-white/5 opacity-20 text-[8px] font-black uppercase tracking-[0.3em] text-center">
        End of Neural Record</div>
    </div>
  </div>

  <!-- THE MATRIX OVERLAY (Parameters) -->
  <div id="matrixOverlay" class="fixed inset-0 z-[200] pointer-events-none group">
    <div id="matrixBackdrop" onclick="toggleMatrix(false)"
      class="absolute inset-0 bg-black/60 backdrop-blur-md opacity-0 transition-opacity duration-700"></div>
    <div id="matrixPanel"
      class="absolute right-0 top-0 bottom-0 w-full max-w-xl bg-studio-panel border-l border-white/5 translate-x-full transition-transform duration-700 ease-in-out p-12 overflow-y-auto">
      <div class="flex items-center justify-between mb-16">
        <div class="flex items-center gap-4">
          <i class="fas fa-sliders-h text-studio-accent text-xs"></i>
          <span class="text-[12px] font-black uppercase tracking-[0.4em]">Matrix Parameters</span>
        </div>
        <button onclick="toggleMatrix(false)"
          class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/5 transition-all">
          <i class="fas fa-times text-xs opacity-30"></i>
        </button>
      </div>

      <div class="space-y-12">
        <div class="space-y-4">
          <label class="text-[9px] font-black uppercase tracking-widest opacity-30">Active Param Chips</label>
          <div id="mjDetectedParams" class="flex flex-wrap gap-3 min-h-[40px]">
            <!-- Chips injected here -->
          </div>
        </div>

        <div class="space-y-4 pt-10 border-t border-white/5">
          <div class="flex items-center justify-between gap-4">
            <label class="text-[9px] font-black uppercase tracking-widest opacity-30">MJ 包装器</label>
          </div>
          <div id="mjPromptPreview"
            class="w-full min-h-[140px] max-h-[40vh] overflow-auto bg-white/[0.02] border border-white/10 rounded-2xl p-5 text-[11px] font-mono leading-relaxed whitespace-pre-wrap break-words select-none"></div>
          <div id="mjWrapperStats" class="text-[9px] font-mono opacity-40 leading-relaxed"></div>
          <div class="text-[9px] opacity-30 leading-relaxed">
            说明：PAD 图、SREF/CREF 仅使用公网可访问的 URL（优先 CDN）；本地 <code>/uploads</code> 不会写入包装器。
          </div>
        </div>

        <div class="space-y-4 pt-10 border-t border-white/5">
          <div class="flex items-center justify-between gap-4">
            <label class="text-[9px] font-black uppercase tracking-widest opacity-30">参考图选择（PAD / SREF / CREF）</label>
            <button id="clearRefsBtn" type="button"
              class="btn-studio btn-studio-outline !px-4 !py-2 !text-[8px] !rounded-xl hover:text-white">
              Clear Pad
            </button>
          </div>
          <div id="referenceList" class="grid grid-cols-4 gap-3"></div>
        </div>

        <div class="space-y-8 pt-12 border-t border-white/5 text-[10px] opacity-40 italic">
          More granular parameter controls coming in next firmware update. Use commands like --stylize or --chaos
          directly in prompt for now.
        </div>
      </div>
    </div>
  </div>

  <!-- TINY HUD FOOTER -->
  <div
    class="fixed bottom-4 left-6 pointer-events-none opacity-20 text-[8px] font-black uppercase tracking-[0.4em] z-[50]">
    Studio Layer 9 // Enterprise Protocol
  </div>

  </div>

  <script type="module" src="/assets/app.js"></script>

  <script>
    function toggleVault(open) {
      const overlay = document.getElementById('historyOverlay');
      const panel = document.getElementById('historyPanel');
      const backdrop = document.getElementById('historyBackdrop');
      if (!overlay || !panel || !backdrop) return;

      if (open) {
        overlay.classList.remove('pointer-events-none');
        panel.classList.remove('translate-x-full');
        backdrop.classList.add('opacity-100');
        document.body.style.overflow = 'hidden';
      } else {
        overlay.classList.add('pointer-events-none');
        panel.classList.add('translate-x-full');
        backdrop.classList.remove('opacity-100');
        document.body.style.overflow = '';
      }
    }

    function toggleMatrix(open) {
      const overlay = document.getElementById('matrixOverlay');
      const panel = document.getElementById('matrixPanel');
      const backdrop = document.getElementById('matrixBackdrop');
      if (!overlay || !panel || !backdrop) return;

      if (open) {
        overlay.classList.remove('pointer-events-none');
        panel.classList.remove('translate-x-full');
        backdrop.classList.add('opacity-100');
        document.body.style.overflow = 'hidden';
      } else {
        overlay.classList.add('pointer-events-none');
        panel.classList.add('translate-x-full');
        backdrop.classList.remove('opacity-100');
        document.body.style.overflow = '';
      }
    }

    // Bridge the button
    window.scrollToHistory = () => toggleVault(true);
    window.toggleMatrix = toggleMatrix;

    // Aspect Ratio Logic
    document.querySelectorAll('.mj-ar-btn').forEach(btn => {
      btn.onclick = () => {
        const ar = btn.getAttribute('data-ar');
        const input = document.getElementById('promptInput');
        const currentLabel = document.getElementById('mjArCurrent');
        if (!input || !ar) return;

        // Update visual label
        if (currentLabel) currentLabel.textContent = `--ar ${ar}`;

        // Clean existing --ar from prompt
        let val = input.value.replace(/--ar\s+\d+:\d+/g, '').trim();
        input.value = `${val} --ar ${ar}`;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.focus();
      };
    });
  </script>
</body>

</html>
