# Kling è§†é¢‘ç”Ÿæˆ API å°è£…

## ğŸ“¦ æ¨¡å—è¯´æ˜

å·²å°† Kling å›¾ç”Ÿè§†é¢‘ API å°è£…æˆç»“æ„åŒ–çš„ Python æ¨¡å—ã€‚

## âš ï¸ é‡è¦æç¤º

**æ­¤ API æ¯æ¬¡è°ƒç”¨éƒ½æœ‰è´¹ç”¨ï¼** ä½¿ç”¨å‰åŠ¡å¿…ï¼š
1. éªŒè¯è¯·æ±‚å‚æ•°
2. äº†è§£è®¡è´¹è§„åˆ™
3. å…ˆç”¨å°è§„æ¨¡æµ‹è¯•

## ğŸ“ æ–‡ä»¶ç»“æ„

```
kling/
â”œâ”€â”€ __init__.py              # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ kling_client.py          # æ ¸å¿ƒå®¢æˆ·ç«¯ (ä¸»è¦ä»£ç )
â”œâ”€â”€ kling_examples.py        # ä½¿ç”¨ç¤ºä¾‹ (å¹²è·‘æ¨¡å¼)
â”œâ”€â”€ test_kling_payload.py    # Payload æ ¼å¼æµ‹è¯•
â””â”€â”€ README.md                # è‹±æ–‡æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```python
from kling import KlingClient, create_simple_video_request

# åˆå§‹åŒ–å®¢æˆ·ç«¯
client = KlingClient(api_token="ä½ çš„token")

# åˆ›å»ºè¯·æ±‚
request = create_simple_video_request(
    model_name="kling-v2-6",
    image_url="https://example.com/image.jpg",
    prompt="ç¾ä¸½çš„æ—¥è½åœºæ™¯ï¼Œè½»æŸ”çš„ç§»åŠ¨",
    duration="5"
)

# éªŒè¯è¯·æ±‚ï¼ˆå¼ºçƒˆæ¨èï¼ï¼‰
is_valid, error = client.validate_request(request)
if is_valid:
    # å‘é€è¯·æ±‚ï¼ˆä¼šäº§ç”Ÿè´¹ç”¨ï¼‰
    response = client.generate_video(request)
    print(response)
else:
    print(f"è¯·æ±‚æ— æ•ˆ: {error}")
```

### 2. å¸¦ç›¸æœºæ§åˆ¶

```python
from kling import create_video_with_camera_control

request = create_video_with_camera_control(
    model_name="kling-v2-6",
    image_url="https://example.com/image.jpg",
    horizontal=1.0,   # å‘å³ç§»åŠ¨
    vertical=0.0,     # ä¸å‚ç›´ç§»åŠ¨
    zoom=0.5,         # è½»å¾®æ”¾å¤§
    duration="5"
)
```

### 3. åŠ¨æ€é®ç½©

```python
from kling import create_video_with_dynamic_mask

# å®šä¹‰é®ç½©ç§»åŠ¨è½¨è¿¹
trajectories = [
    (0.0, 0.0),  # èµ·ç‚¹
    (0.5, 0.5),  # ä¸­ç‚¹
    (1.0, 1.0)   # ç»ˆç‚¹
]

request = create_video_with_dynamic_mask(
    model_name="kling-v2-6",
    image_url="https://example.com/image.jpg",
    mask_url="https://example.com/mask.jpg",
    trajectories=trajectories,
    duration="5"
)
```

### 4. é«˜çº§é…ç½®

```python
from kling import KlingVideoRequest, CameraControl

request = KlingVideoRequest(
    model_name="kling-v2-6",
    image="https://example.com/image.jpg",
    prompt="ç”µå½±çº§ç›¸æœºè¿åŠ¨ç©¿è¿‡æ£®æ—",
    negative_prompt="æ¨¡ç³Šï¼Œä½è´¨é‡ï¼Œæ‰­æ›²",
    cfg_scale=0.7,
    mode="pro",  # ä¸“ä¸šæ¨¡å¼ï¼Œæ›´é«˜è´¨é‡
    duration="10",
    camera_control=CameraControl(
        type="simple",
        config={
            "horizontal": 1.0,
            "vertical": 0.0,
            "zoom": 0.5
        }
    )
)
```

## ğŸ” æŸ¥è¯¢è§†é¢‘çŠ¶æ€

### 1. ç®€å•æŸ¥è¯¢
```python
# æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
task_id = "827297867001249878"
response = client.query_video(task_id)

print(f"çŠ¶æ€: {response['data']['status']}")
if response['data']['status'] == 'completed':
    print(f"è§†é¢‘URL: {response['data']['video_url']}")
```

### 2. ç”Ÿæˆå¹¶æŸ¥è¯¢
```python
# ç”Ÿæˆè§†é¢‘
request = create_simple_video_request(
    model_name="kling-v2-6",
    image_url="https://example.com/image.jpg",
    prompt="ç¾ä¸½çš„æ—¥è½",
    duration="5"
)

response = client.generate_video(request)
task_id = response["data"]["task_id"]

# æŸ¥è¯¢çŠ¶æ€
result = client.query_video(task_id)
print(f"çŠ¶æ€: {result['data']['status']}")
```

### 3. ç­‰å¾…å®Œæˆ
```python
from kling import wait_for_video_completion

# ç”Ÿæˆè§†é¢‘
response = client.generate_video(request)
task_id = response["data"]["task_id"]

# ç­‰å¾…å®Œæˆï¼ˆè‡ªåŠ¨è½®è¯¢ï¼‰
result = wait_for_video_completion(
    client,
    task_id,
    max_wait_seconds=300,  # æœ€å¤šç­‰å¾…5åˆ†é’Ÿ
    poll_interval=10       # æ¯10ç§’æŸ¥è¯¢ä¸€æ¬¡
)

print(f"è§†é¢‘URL: {result['data']['video_url']}")
```

### 4. è‡ªå®šä¹‰è½®è¯¢
```python
import time

task_id = "your-task-id"
max_attempts = 30

for attempt in range(max_attempts):
    response = client.query_video(task_id)
    status = response["data"]["status"]
    progress = response["data"].get("progress", 0)

    print(f"å°è¯• {attempt + 1}: {status} ({progress}%)")

    if status == "completed":
        print(f"å®Œæˆ: {response['data']['video_url']}")
        break
    elif status == "failed":
        print(f"å¤±è´¥: {response['data']['error']}")
        break

    time.sleep(10)
```

## ğŸ“– å‚æ•°è¯´æ˜

### å¿…éœ€å‚æ•°
- `model_name`: æ¨¡å‹åç§°ï¼ˆå¦‚ "kling-v2-6"ï¼‰
- `image`: æºå›¾ç‰‡ URL

### å¯é€‰å‚æ•°
- `prompt`: æ–‡æœ¬æç¤ºè¯
- `negative_prompt`: è¦é¿å…çš„å…ƒç´ 
- `cfg_scale`: é…ç½®æ¯”ä¾‹ (0.0-1.0ï¼Œé»˜è®¤ 0.5)
- `mode`: ç”Ÿæˆæ¨¡å¼
  - `"std"`: æ ‡å‡†æ¨¡å¼ï¼ˆæ›´å¿«ï¼Œæˆæœ¬ä½ï¼‰
  - `"pro"`: ä¸“ä¸šæ¨¡å¼ï¼ˆæ›´æ…¢ï¼Œæˆæœ¬é«˜ï¼‰
- `duration`: è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼Œé»˜è®¤ "5"ï¼‰
- `camera_control`: ç›¸æœºæ§åˆ¶
- `dynamic_masks`: åŠ¨æ€é®ç½©åˆ—è¡¨
- `callback_url`: å®Œæˆåçš„å›è°ƒ URL
- `external_task_id`: å¤–éƒ¨ä»»åŠ¡ ID

## ğŸ” å‚æ•°éªŒè¯

ä½¿ç”¨å‰åŠ¡å¿…éªŒè¯ï¼š

```python
is_valid, error = client.validate_request(request)
if not is_valid:
    print(f"è¯·æ±‚æ— æ•ˆ: {error}")
    return

# å®‰å…¨å‘é€
response = client.generate_video(request)
```

### éªŒè¯æ£€æŸ¥é¡¹
- âœ“ å¿…éœ€å­—æ®µå­˜åœ¨
- âœ“ cfg_scale åœ¨ 0.0-1.0 èŒƒå›´å†…
- âœ“ mode æ˜¯ "std" æˆ– "pro"
- âœ“ duration æ˜¯æ­£æ•°
- âœ“ å›¾ç‰‡ URL å·²æä¾›

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é¢„è§ˆè¯·æ±‚å†…å®¹
```python
# æŸ¥çœ‹å°†è¦å‘é€çš„å†…å®¹
print(request.to_json())
```

### 2. ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨ Token
```python
import os
from kling import KlingClient

token = os.getenv("KLING_API_TOKEN")
client = KlingClient(api_token=token)
```

### 3. é”™è¯¯å¤„ç†
```python
try:
    response = client.generate_video(request)
    print(f"æˆåŠŸ: {response}")
except Exception as e:
    print(f"API é”™è¯¯: {e}")
```

### 4. ä½¿ç”¨å›è°ƒå¤„ç†é•¿æ—¶é—´æ“ä½œ
```python
request = KlingVideoRequest(
    model_name="kling-v2-6",
    image="https://example.com/image.jpg",
    callback_url="https://your-server.com/webhook",
    external_task_id="task-123"
)
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œç¤ºä¾‹ï¼ˆå¹²è·‘æ¨¡å¼ï¼Œä¸äº§ç”Ÿè´¹ç”¨ï¼‰
```bash
python3 -m kling.kling_examples
```

### è¿è¡Œ Payload æ ¼å¼æµ‹è¯•
```bash
python3 -m kling.test_kling_payload
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
âœ“ Valid JSON
âœ“ Model: kling-v2-6
âœ“ Image URL present: True
âœ“ Dynamic masks count: 1
âœ“ Trajectories count: 2
âœ“ Duration: 5
âœ“ Mode: std
âœ“ CFG Scale: 0.5
```

## ğŸ“Š å®é™… Payload æ ¼å¼

å°è£…ç”Ÿæˆçš„ JSON æ ¼å¼ä¸ API è¦æ±‚å®Œå…¨åŒ¹é…ï¼š

```json
{
  "model_name": "kling-v2-6",
  "image": "https://example.com/image.jpg",
  "image_tail": "",
  "prompt": "",
  "negative_prompt": "",
  "voice_list": [{"voiceId": ""}],
  "sound": "",
  "cfg_scale": 0.5,
  "mode": "std",
  "static_mask": "",
  "dynamic_masks": [
    {
      "mask": "https://example.com/mask.jpg",
      "trajectories": [
        {"x": 0, "y": 0},
        {"x": 1, "y": 1}
      ]
    }
  ],
  "duration": "5",
  "callback_url": "",
  "external_task_id": ""
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: ç®€å•å›¾ç”Ÿè§†é¢‘
```python
request = create_simple_video_request(
    model_name="kling-v2-6",
    image_url="https://example.com/landscape.jpg",
    prompt="è½»æŸ”çš„é£å¹è¿‡æ ‘æ—",
    duration="5"
)
```

### åœºæ™¯ 2: ç›¸æœºè¿åŠ¨
```python
request = create_video_with_camera_control(
    model_name="kling-v2-6",
    image_url="https://example.com/scene.jpg",
    horizontal=1.0,  # å‘å³å¹³ç§»
    zoom=0.3,        # è½»å¾®æ”¾å¤§
    duration="5"
)
```

### åœºæ™¯ 3: å±€éƒ¨åŠ¨ç”»
```python
# åªè®©å›¾ç‰‡çš„æŸä¸ªåŒºåŸŸåŠ¨èµ·æ¥
request = create_video_with_dynamic_mask(
    model_name="kling-v2-6",
    image_url="https://example.com/portrait.jpg",
    mask_url="https://example.com/hair_mask.jpg",  # å¤´å‘åŒºåŸŸ
    trajectories=[(0, 0), (0.2, 0.1), (0, 0)],  # è½»å¾®é£˜åŠ¨
    duration="5"
)
```

### åœºæ™¯ 4: æ‰¹é‡å¤„ç†
```python
images = [
    "https://example.com/img1.jpg",
    "https://example.com/img2.jpg",
    "https://example.com/img3.jpg"
]

for img_url in images:
    request = create_simple_video_request(
        model_name="kling-v2-6",
        image_url=img_url,
        duration="5"
    )

    # éªŒè¯
    is_valid, error = client.validate_request(request)
    if is_valid:
        # å‘é€è¯·æ±‚
        response = client.generate_video(request)
        print(f"å¤„ç† {img_url}: {response}")
```

## ğŸ’° æˆæœ¬æ§åˆ¶å»ºè®®

1. **å…ˆç”¨æ ‡å‡†æ¨¡å¼æµ‹è¯•**
   ```python
   mode="std"  # æ›´ä¾¿å®œ
   ```

2. **ä»çŸ­æ—¶é•¿å¼€å§‹**
   ```python
   duration="5"  # æœ€çŸ­æ—¶é•¿
   ```

3. **éªŒè¯åå†å‘é€**
   ```python
   is_valid, error = client.validate_request(request)
   if not is_valid:
       return  # é¿å…æ— æ•ˆè¯·æ±‚äº§ç”Ÿè´¹ç”¨
   ```

4. **è®°å½•æ‰€æœ‰è¯·æ±‚**
   ```python
   import logging
   logging.info(f"Sending request: {request.to_dict()}")
   response = client.generate_video(request)
   logging.info(f"Response: {response}")
   ```

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¸è¦æäº¤ Token åˆ°ç‰ˆæœ¬æ§åˆ¶**
   ```bash
   # .env.local
   KLING_API_TOKEN=your-token-here
   ```

2. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   ```python
   import os
   token = os.getenv("KLING_API_TOKEN")
   ```

3. **éªŒè¯ç”¨æˆ·è¾“å…¥**
   ```python
   # éªŒè¯ URL æ ¼å¼
   if not image_url.startswith("https://"):
       raise ValueError("Invalid image URL")
   ```

4. **å®æ–½é€Ÿç‡é™åˆ¶**
   ```python
   import time
   time.sleep(1)  # è¯·æ±‚ä¹‹é—´ç­‰å¾…
   ```

## ğŸ› å¸¸è§é—®é¢˜

### Q: cfg_scale è¶…å‡ºèŒƒå›´
```python
# é”™è¯¯
cfg_scale=1.5  # è¶…å‡º 0.0-1.0 èŒƒå›´

# æ­£ç¡®
cfg_scale=0.7  # åœ¨èŒƒå›´å†…
```

### Q: mode å€¼æ— æ•ˆ
```python
# é”™è¯¯
mode="standard"  # æ— æ•ˆå€¼

# æ­£ç¡®
mode="std"  # æˆ– "pro"
```

### Q: ç¼ºå°‘å¿…éœ€å­—æ®µ
```python
# é”™è¯¯
request = KlingVideoRequest(model_name="kling-v2-6")  # ç¼ºå°‘ image

# æ­£ç¡®
request = KlingVideoRequest(
    model_name="kling-v2-6",
    image="https://example.com/image.jpg"
)
```

## ğŸ“ å®Œæ•´ç¤ºä¾‹

```python
import os
from kling import KlingClient, create_simple_video_request

# 1. ä»ç¯å¢ƒå˜é‡è·å– token
token = os.getenv("KLING_API_TOKEN")
if not token:
    raise ValueError("è¯·è®¾ç½® KLING_API_TOKEN ç¯å¢ƒå˜é‡")

# 2. åˆå§‹åŒ–å®¢æˆ·ç«¯
client = KlingClient(api_token=token)

# 3. åˆ›å»ºè¯·æ±‚
request = create_simple_video_request(
    model_name="kling-v2-6",
    image_url="https://example.com/beautiful-landscape.jpg",
    prompt="æ—¥è½æ—¶åˆ†ï¼Œäº‘å½©ç¼“ç¼“ç§»åŠ¨",
    duration="5",
    mode="std"
)

# 4. é¢„è§ˆè¯·æ±‚
print("è¯·æ±‚å†…å®¹:")
print(request.to_json())

# 5. éªŒè¯è¯·æ±‚
is_valid, error = client.validate_request(request)
if not is_valid:
    print(f"âŒ è¯·æ±‚æ— æ•ˆ: {error}")
    exit(1)

print("âœ“ è¯·æ±‚éªŒè¯é€šè¿‡")

# 6. ç¡®è®¤å‘é€ï¼ˆå› ä¸ºä¼šäº§ç”Ÿè´¹ç”¨ï¼‰
confirm = input("ç¡®è®¤å‘é€è¯·æ±‚ï¼Ÿ(yes/no): ")
if confirm.lower() != "yes":
    print("å·²å–æ¶ˆ")
    exit(0)

# 7. å‘é€è¯·æ±‚
try:
    response = client.generate_video(request)
    print(f"âœ“ æˆåŠŸ: {response}")
except Exception as e:
    print(f"âŒ é”™è¯¯: {e}")
```

## ğŸ‰ æ€»ç»“

âœ… å®Œæ•´å°è£… Kling API
âœ… ç±»å‹å®‰å…¨çš„æ•°æ®ç»“æ„
âœ… å‚æ•°éªŒè¯
âœ… è¾…åŠ©å‡½æ•°
âœ… è¯¦ç»†æ–‡æ¡£
âœ… æµ‹è¯•ç”¨ä¾‹
âœ… å¹²è·‘æ¨¡å¼ç¤ºä¾‹

ç°åœ¨å¯ä»¥å®‰å…¨ã€æ–¹ä¾¿åœ°ä½¿ç”¨ Kling è§†é¢‘ç”Ÿæˆ API äº†ï¼
